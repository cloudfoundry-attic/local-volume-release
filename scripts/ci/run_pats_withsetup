#!/bin/bash
# vim: set ft=sh

set -e -x

scripts_path=./$(dirname $0)/..
eval $($scripts_path/get_paths.sh)

if [ "$(uname)" == "Darwin" ]; then
    export GOPATH=`greadlink -f ${scripts_path}/..`
else
    export GOPATH=`readlink -f ${scripts_path}/..`
fi
export PATH=$GOPATH/bin:$PATH

absolute_path() {
  (pushd $1 && pwd && popd)
}

base_path=$(absolute_path `dirname $0`)

source ${scripts_path}/ci/utils.sh
check_param CF_USERNAME
check_param CF_API_ENDPOINT
check_param APPS_DOMAIN
check_param SERVICE_NAME
check_param PLAN_NAME
check_param BROKER_URL
check_param BROKER_USER


# CF_PASSWORD and BROKER_PASSWORD can either be passed in as environment variables, or extracted from a deployment-vars file
# in environments where they are dynamically generated by BOSH
if [ -z "$CF_PASSWORD" ]; then
    persi-ci/scripts/ci/bbl_bosh-get_env
    source bosh-env/set-env.sh

    bosh_manifest_password_variable_name=$BROKER_PASSWORD_KEY
    CF_PASSWORD=`credhub find -j -n ${bosh_manifest_password_variable_name} | jq -r .credentials[].name | xargs credhub get -j -n | jq -r .value`
fi

if [ -z "$BROKER_PASSWORD" ]; then
    persi-ci/scripts/ci/bbl_bosh-get_env
    source bosh-env/set-env.sh

    bosh_manifest_password_variable_name=csi-nfsbroker-password
    BROKER_PASSWORD=`credhub find -j -n ${bosh_manifest_password_variable_name} | jq -r .credentials[].name | xargs credhub get -j -n | jq -r .value`
fi

go get github.com/onsi/ginkgo/ginkgo
export TEST_WINDOWS_CELL=${TEST_WINDOWS_CELL}

${scripts_path}/run-pats \
${CF_USERNAME} \
${CF_PASSWORD} \
${CF_API_ENDPOINT} \
${APPS_DOMAIN} \
${SERVICE_NAME} \
${PLAN_NAME} \
${BROKER_URL} \
${BROKER_USER} \
${BROKER_PASSWORD}
